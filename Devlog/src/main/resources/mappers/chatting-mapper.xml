<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.devlog.project.chatting.mapper.ChattingMapper">
	
	<select id="selectChatList" resultType="com.devlog.project.chatting.dto.ChattingDTO$ChattingListDTO">
		SELECT
				CR.CHATTING_ROOM_NO AS "chattingRoomNo",
				CR.ROOM_TYPE AS "roomType",
				CU.PINNED_YN AS "pinnedYn",
				CASE
					WHEN CR.ROOM_TYPE = 'PRIVATE' THEN (SELECT MEMBER_NICKNAME FROM MEMBER M2
														JOIN CHATTING_USER U2 ON M2.MEMBER_NO = U2.MEMBER_NO
														WHERE U2.CHATTING_ROOM_NO = CR.CHATTING_ROOM_NO
														AND U2.MEMBER_NO != ${memberNo})
					ELSE CR.CHATTING_ROOM_NAME
				END AS "displayName",

				CASE
					WHEN CR.ROOM_TYPE = 'PRIVATE' THEN (SELECT PROFILE_IMG FROM MEMBER M2
														JOIN CHATTING_USER U2 ON M2.MEMBER_NO = U2.MEMBER_NO
														WHERE U2.CHATTING_ROOM_NO = CR.CHATTING_ROOM_NO
														AND U2.MEMBER_NO != ${memberNo})
					ELSE CR.ROOM_IMG
				END AS "roomImg",

				M.MESSAGE_CONTENT AS "lastMessage",
				M.SEND_TIME AS "lastMessageAt",
				(SELECT COUNT(*) FROM MESSAGE M2
					WHERE M2.CHATTING_ROOM_NO = CR.CHATTING_ROOM_NO
					AND M2.MESSAGE_NO > CU.LAST_READ_NO) AS "unreadCount"
			
			FROM CHATTING_ROOM CR
			JOIN CHATTING_USER CU
			ON CU.CHATTING_ROOM_NO = CR.CHATTING_ROOM_NO
			LEFT JOIN MESSAGE M ON M.MESSAGE_NO = 
			(SELECT MAX(m.MESSAGE_NO)
			FROM MESSAGE m
			WHERE m.CHATTING_ROOM_NO = CR.CHATTING_ROOM_NO)
			WHERE CU.MEMBER_NO =${memberNo}
			ORDER BY PINNED_YN DESC, M.SEND_TIME DESC NULLS LAST
	</select>
</mapper>