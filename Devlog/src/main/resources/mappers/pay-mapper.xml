<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.devlog.project.pay.mapper.PayMapper">


	<!-- 내 커피콩 조회-->
	<select id="selectMyBeans" resultType="PayDTO">
		SELECT MEMBER_NO, BEANS_AMOUNT 
		FROM MEMBER
		WHERE MEMBER_NO = #{memberNo}
	</select>
	
	
	<!-- 내 커피콩 내역 조회-->
	<select id="selectBeansHistory" resultType="PayDTO">
	    SELECT 
	        H.BEANS_HISTORY,
	        H.PAY_AMOUNT AS payAmount,
	        ABS(H.PAY_AMOUNT) AS displayPrice,
	        TO_CHAR(H.REG_DATE, 'YYYY-MM-DD HH24:MI') AS payDate,
	        P.PAYMENT_ID AS paymentId,
	        P.BEANS_PAY_NO AS beansPayNo,
	        P.USED_AMOUNT AS usedAmount,
	        H.TRADE_NO AS tradeNo,
	        CASE 
	            -- 환전인지 먼저 확인 (JOIN이 성공하면 EXCHANGE_NO가 있음)
	            WHEN E.EXCHANGE_NO IS NOT NULL THEN '환전'
	            -- 환전이 아닐 때, 거래 번호가 없고 음수면 '취소'
	            WHEN H.PAY_AMOUNT <![CDATA[ < ]]> 0 AND H.TRADE_NO IS NULL THEN '취소'
	            -- 양수고 거래 번호 없으면 '충전'
	            WHEN H.PAY_AMOUNT > 0 AND H.TRADE_NO IS NULL THEN '충전'
	            -- 나머지는 거래 내역
	            ELSE (SELECT T.CONTENT_TYPE FROM COFFEE_BEANS_TRADE T WHERE T.TRADE_NO = H.TRADE_NO)
	        END AS contentType
	    FROM COFFEE_BEANS_HISTORY H
	    -- 충전 JOIN
	    LEFT JOIN COFFEE_BEANS_PAY P ON (
	        H.MEMBER_NO = P.MEMBER_NO 
	        AND ABS(H.PAY_AMOUNT) = P.PRICE 
	        AND TO_CHAR(H.REG_DATE, 'YYYYMMDDHH24MI') = TO_CHAR(P.PAY_DATE, 'YYYYMMDDHH24MI')
	    )
	    LEFT JOIN COFFEE_BEANS_EXCHANGE E ON (
	        H.MEMBER_NO = E.MEMBER_NO
	        AND TO_CHAR(H.REG_DATE, 'YYYYMMDDHH24MI') = TO_CHAR(E.EXCHANGE_REQ_DATE, 'YYYYMMDDHH24MI')
	    )
	    WHERE H.MEMBER_NO = #{memberNo}
	    ORDER BY H.BEANS_HISTORY DESC
	</select>

	
	<!-- 결제 정보 저장 -->	
	<insert id="insertPayment" parameterType="PayDTO">
	    <selectKey keyProperty="beansPayNo" resultType="_int" order="BEFORE">
	        SELECT SEQ_PAY_NO.NEXTVAL FROM DUAL
	    </selectKey>
	    
	    INSERT INTO COFFEE_BEANS_PAY (
	        BEANS_PAY_NO, 
	        MEMBER_NO, 
	        PAYMENT_ID, 
	        PAY_METHOD, 
	        PRICE, 
	        PAY_DATE, 
	        USED_AMOUNT, 
	        PAY_STATUS
	    ) VALUES (
	        #{beansPayNo}, 
	        #{memberNo}, 
	        #{paymentId}, 
	        #{payMethod}, 
	        #{price}, 
	        SYSDATE, 
	        0, 
	        1
	    )
	</insert>
		
	<insert id="insertHistory">
	    INSERT INTO COFFEE_BEANS_HISTORY (
	        BEANS_HISTORY, 
	        MEMBER_NO, 
	        PAY_AMOUNT, 
	        TRADE_NO
	    ) VALUES (
	        SEQ_HISTORY_NO.NEXTVAL, 
	        #{memberNo}, 
	        #{price}, 
	        NULL  )
	</insert>
	
	<update id="updateMemberBeans">
	    UPDATE MEMBER 
	    SET BEANS_AMOUNT = BEANS_AMOUNT + #{price}
	    WHERE MEMBER_NO = #{memberNo}
	</update>
	
	
	<select id="selectPaymentByNo" resultType="PayDTO">
	    SELECT * FROM COFFEE_BEANS_PAY WHERE BEANS_PAY_NO = #{beansPayNo}
	</select>
	
	<update id="updatePayStatusCancel">
	    UPDATE COFFEE_BEANS_PAY 
	    SET PAY_STATUS = 2
	    WHERE BEANS_PAY_NO = #{beansPayNo}
	      AND PAY_STATUS != 2
	</update>
	
	
	<!-- 환전 -->
	<insert id="insertExchange" parameterType="PayDTO">
			INSERT INTO COFFEE_BEANS_EXCHANGE (
				EXCHANGE_NO,
				MEMBER_NO,
				RETURN_BANK,      REQUEST_AMOUNT,   EXCHANGE_HOLDER,
				EXCHANGE_ACCOUNT,
				EXCHANGE_REQ_DATE
			) VALUES (
				SEQ_EXCHANGE_NO.NEXTVAL,
				#{memberNo},
				#{returnBank},
				#{requestAmount},
				#{exchangeHolder},
				#{exchangeAccount},
				CURRENT_TIMESTAMP
			)
		</insert>
		
		
		
	<!-- 은행코드 -->
	<select id="selectBankList" resultType="map">
	    SELECT 
	        RETURN_BANK AS "bankCode", 
	        BANK_NAME AS "bankName"
	    FROM BANK_INFO
	    ORDER BY BANK_NAME ASC
	</select>



	<!-- 환전 ok -->
	<update id="okExchange">
	UPDATE "COFFEE_BEANS_EXCHANGE" 
		SET EXCHANGE_OK_DATE = SYSDATE 
		WHERE EXCHANGE_NO = #{exchangeNo}
	</update>
	
	
	
	<!-- 관리자용 -->
	<select id="selectAllBeansHistory" resultType="PayDTO">
	    SELECT * FROM (
	        SELECT 
	            H.BEANS_HISTORY,
	            H.PAY_AMOUNT AS payAmount,
	            CASE 
	                WHEN E.EXCHANGE_NO IS NOT NULL THEN E.REQUEST_AMOUNT 
	                ELSE ABS(H.PAY_AMOUNT) 
	            END AS displayPrice,
	            TO_CHAR(H.REG_DATE, 'YYYY-MM-DD HH24:MI') AS payDate,
	            M.MEMBER_NICKNAME,
	            E.EXCHANGE_NO,
	            BI.BANK_NAME AS returnBankName,
	            E.EXCHANGE_ACCOUNT,
	            E.EXCHANGE_HOLDER,
	            TO_CHAR(E.EXCHANGE_OK_DATE, 'YYYY-MM-DD HH24:MI') AS exchangeOkDate,
	            CASE 
	                WHEN E.EXCHANGE_NO IS NOT NULL THEN '환전'
	                WHEN H.PAY_AMOUNT <![CDATA[ < ]]> 0 AND H.TRADE_NO IS NULL THEN '취소'
	                WHEN H.PAY_AMOUNT > 0 AND H.TRADE_NO IS NULL THEN '충전'
	                ELSE '사용' 
	            END AS contentType,
	            CASE
	                WHEN E.EXCHANGE_NO IS NOT NULL AND E.EXCHANGE_OK_DATE IS NULL THEN '요청'
	                ELSE '완료' 
	            END AS status
	        FROM COFFEE_BEANS_HISTORY H
	        JOIN "MEMBER" M ON (H.MEMBER_NO = M.MEMBER_NO)
	        LEFT JOIN COFFEE_BEANS_EXCHANGE E ON (
	            H.MEMBER_NO = E.MEMBER_NO
	            AND TO_CHAR(H.REG_DATE, 'YYYYMMDDHH24MI') = TO_CHAR(E.EXCHANGE_REQ_DATE, 'YYYYMMDDHH24MI')
	        )
	        LEFT JOIN BANK_INFO BI ON (E.RETURN_BANK = BI.RETURN_BANK)
	    )
	    <where>
	        <if test="query != null and query != ''">
	            AND (
	                MEMBER_NICKNAME LIKE '%' || #{query} || '%' OR
	                EXCHANGE_ACCOUNT LIKE '%' || #{query} || '%' OR
	                EXCHANGE_HOLDER LIKE '%' || #{query} || '%' OR
	                contentType LIKE '%' || #{query} || '%'
	            )
	        </if>
	        
	        <if test="type != null and type != ''">
	            AND contentType = #{type}
	        </if>
	    </where>
	    ORDER BY BEANS_HISTORY DESC
	</select>
		
</mapper>